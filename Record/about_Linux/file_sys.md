# Linux File System

*理解和管理Linux文件系统*

## 基本的Linux文件系统

### ext

*extend filesystem*

> **ext**
>
> 1. 使用虚拟目录来操作硬件设备，在物理设备上按定长的块来存储数据
> 2. 采用索引来存储和定位文件信息，通过索引号来标识文件
> 3. 索引节点包括的信息：文件名、文件大小、文件属主和属组、文件访问权限、指向存储文件数据的硬盘的指针
>
> *缺点：数据碎片化*
>
> **ext2**
>
> 1. 是ext文件系统基本功能的一个扩展，保持了同样的结构
> 2. 索引点信息添加：创建时间、修改时间、最后访问时间；允许更大的文件
> 3. 通过按组分配磁盘块来减轻碎片化

**缺点：索引表的更新和文件存储的更新可能不同步，导致文件系统无法索引到已经存在的文件，且容易在系统崩溃或者断电时损坏**



### 日志文件系统

> 特点：在ext上增加了一层：先将文件的更改写入到日志中，在数据成功写到存储设备和索引节点表之后，再删除对应的日志条目
>
> *文件系统的日志方法：数据模式、有序模式、回写模式——在安全性和性能之间做出抉择*
>
> **ext3**
>
> 1. 采用和ext2文件系统相同的索引节点表结构
> 2. 安全性增强：给每个存储设备增加了一个日志文件（默认是有序模式，可以在创建文件系统时修改为其他模式
>
> *缺点：无法恢复误删的文件；没有任何内建的数据压缩功能；不支持加密文件*
>
> **ext4**
>
> 1. 扩展了ext3文件系统的功能（支持数据压缩和加密
> 2. 新特性：支持区段（extent）特性，区段在存储设备上按块分配空间，但在索引节点表中只保存起始块的位置，节省空间；引入了块预分配技术（block preallocation），用0填满预留的数据块，而不会将其分配给其他文件
>
> **Reiser**
>
> 1. 只支持回写模式的日志（成为最快的日志文件系统之一
> 2. 新特性：可以在线调整已有文件系统的大小（方便为已有的文件系统扩容）；引入尾部压缩技术（tailpacking），可以将一个文件的数据填进另一个文件的数据块中的空白空间
>
> **JFS(Journaled File System)**
>
> 1. 采用有序的日志模式
> 2. 优化：采用基于区段的文件分配（为每个写入存储设备的文件分配一组块），减少碎片
> 3. 多用于IBM Linux上
>
> **XFS**
>
> 1. 采用回写模式的日志
> 2. 允许在线调整已有文件系统的大小，但是只能扩大不能缩小



### 写时复制文件系统

*copy on write(COW)*

> 特点：利用快照兼顾了安全性和性能。修改过的数据不会直接覆盖当前数据，而是被放入文件系统中的另一个位置上；即便是数据修改已经完成， 之前的旧数据也不会被重写
>
> **Btrf**
>
> *又称：B树文件系统*
>
> 1. 在Reiser4上增进了可靠性，稳定、易用
> 2. 可以动态调整已挂载的文件系统的大小
>
> **ZFS**
>
> 稳定，与Reiser4、Btrfs和ext4势均力敌
>
> *缺点：没有使用GPL许可，所以无法成为Linux默认的文件系统*



## 创建文件系统

```bash
#创建分区（fdisk是交互式的，使用较为方便，不多介绍
sudo fdisk /dev/sdx #打开sdx物理磁盘（x可以为a、b等，分别代表第一驱动器、第二驱动器
#创建分区的时候，建议先了解主分区（primary partition）和逻辑分区（extended partition）

#创建文件系统（以下命令并非全部都可用，请自行用type xxx查看命令xxx是否可用
mkfs.ext4 #创建一个ext4文件系统（ext3、xfs、zfs、btrfs都是这样的格式创建
mke2fs #创建一个ext2文件系统
mkefs #创建一个ext文件系统
jfs_mkfs #创建一个JFS文件系统
mkreiserfs #创建一个ReiserFS文件系统

#挂载文件系统到挂载点
sudo mkdir /mnt/my_partition
sudo mount -t ext4 /dev/sdb1 /mnt/my_partition #将/dev/sdb1挂载到/mnt/my_partition（-t指定了挂载的文件系统类型
```



## 文件系统的检查与修复

```bash
#每个文件系统都有各自可以和文件系统交互的恢复命令，但是fsck可用于大部分文件系统（ext所有、ReiserFS、JFS、XFS
fsck [options] [filesysytem] #基本命令格式

#fsck使用/etc/fstab文件来自动决定正常挂载到系统上的存储设备的文件系统
#只能在未挂载的文件系统上运行fsck命令
#用法和参数，自行man查询
```



## 逻辑卷管理

*logical volume manager，LVM*

#### 原理理解

> 基本概念：每个物理卷（physical volume，PV）被映射到硬盘上特定的物理分区；多个物理卷集中在一起可以形成一个卷组（volume group，VG）；逻辑卷（logical volume，LV）
>
> 核心：逻辑卷管理系统将卷组视为一个物理硬盘，卷组可能是由分布在多个物理硬盘上的多个物理分区组成的；卷组提供了一个创建逻辑分区的平台，而这些逻辑分区则包含了文件系统；可以使用任意一种标准Linux文件系统来格式化逻辑卷，然后再将它加入Linux虚拟目录中的某个挂载点（关于这些层次关系，建议阅读《Linux命令行于shell脚本编程大全》第三版的P155
>
> **实现存储空间的动态管理**



#### Linux中的LVM

**版本**

> LVM1：只能用于Linux内核2.4版本，仅提供了基本的逻辑卷管理功能
>
> LVM2：可用于Linux内核2.6版本，在标准的LVM1功能外提供了额外的功能

**几个概念**

> 1. 快照：lvm1只能创建只读快照；lvm2可创建可读写快照
> 2. 条带化：lvm2可跨多个物理硬盘创建逻辑卷（提高硬盘性能，但是会增加文件因硬盘故障而丢失的概率
> 3. 镜像：实时更新的逻辑卷的完整副本（LVM会为文件系统的每次写操作执行两次写入，分别写入到主逻辑卷和镜像副本，安全但是会降低系统的写入性能
>
> Linux系统使用逻辑卷来模拟物理分区，并在其中保存文件系统；并且会像处理物理分区一样处理逻辑卷，允许你定义逻辑卷中的文件系统，然后将文件系统挂载到虚拟目录上



#### 使用Linux LVM

```bash
#定义物理卷：在分区的时候选择lvm
sudo pvcreate /dev/sdb1 #将分区标记成Linux LVM系统中的分区
sudo pvdisplay /dev/sdb1 #查看已创建的物理卷列表

#创建物理卷组
sudo vgcreate Vol1 /dev/sdb1 #创建名为Vol1的卷组
sudo vgdisplay Vol1 #查看卷组Vol1的细节

#使用lvcreate命令创建逻辑卷
sudo lvcreate -l 100%FREE -n lvtest Vol1 #在Vol1卷组上创建名为lvtest的逻辑卷，并将Vol1所有的空余空间分配给lvtest
sudo lvdisplay Vol1 #查看创建的逻辑卷Vol1的详细情况

#创建文件系统
sudo mkfs.ext4 /dev/Vol1/lvtest #创建ext4文件系统
sudo mount /dev/Vol1/lvtest /mnt/my_partition #挂载

#修改LVM的命令
#vgchange、vgremove、vgextend、vgreduce、lvextend、lvreduce
```

