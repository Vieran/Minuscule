# HPL_report_pre

### 查看测试平台信息

> **硬件信息（节点cas009）**
>
> CPU: Intel(R) Xeon(R) Gold 6248 CPU, 2.50GHz, 20 cores, 40 processes
>
> ​          cache line 32K
>
> Memory: 187G(total), 180G(left)

> **软件信息**
>
> openMPI-4.0.5
>
> openBLAS-0.3.10
>
> HPL-2.3



### 计算理论值

> **N * N * 8 = memory**
>
> 这里取memory为180G，计算得到N约为155432（如果取memory为187G，计算得到N约为158426
>
> 所以测试的时候，N值取为102400、155432、155500

> **p * q = processes，p <= q，p = 2^n**
>
> 这里取p为4，q为10；以及p为2，q为20

> **NB < 256**
>
> 取NB为4、16、64、128

> **理论峰值 = CPU主频 × CPU每个时钟周期执行浮点运算的次数 × 系统中CPU核心数目**
>
> 计算得到理论峰值为3200 Gflops = 3.2e+03 Gflops



### 测试

**预先测试**

| N     | NB   | P    | Q    | Gflops     |
| ----- | ---- | ---- | ---- | ---------- |
| 10240 | 4    | 2    | 2    | 7.7120e+01 |
| 10240 | 4    | 2    | 8    | 9.9726e+00 |
| 10240 | 4    | 2    | 16   | 4.5205e+00 |
| 10240 | 4    | 4    | 8    | 2.1259e+00 |

*cpu全部都跑满了，但是内存占用没有跑满（n值设置不合理）*



**正式测试**

| N      | NB   | P    | Q    | Gflops     |
| ------ | ---- | ---- | ---- | ---------- |
| 102400 | 4    | 4    | 4    | 6.6118e+01 |
| 102400 | 16   | 4    | 4    | 1.9434e+02 |
| 102400 | 64   | 4    | 4    | 3.9366e+02 |
| 102400 | 128  | 4    | 4    | 4.5752e+02 |
| 102400 | 4    | 4    | 10   | 5.8940e+01 |
| 102400 | 16   | 4    | 10   | 1.8104e+02 |
| 102400 | 64   | 4    | 10   | 3.9880e+02 |
| 102400 | 128  | 4    | 10   | 4.7582e+02 |
| 155432 | 4    | 4    | 4    | 7.4731e+01      |
| 155432 | 16   | 4    | 4    | 2.4729e+02      |
| 155432 | 64   | 4    | 4    | 5.7987e+02      |
| 155432 | 128  | 4    | 4    | 6.4051e+02      |
| 155432 | 4    | 4    | 10   | 7.2379e+01      |
| 155432 | 16   | 4    | 10   | 2.4205e+02      |
| 155432 | 64   | 4    | 10   | 6.0176e+02      |
| 155432 | 128  | 4    | 10   | 6.9677e+02      |
| 155432 | 128  | 2    | 10   | 8.9053e+02      |
| 155432 | 128  | 2    | 20   | 8.5193e+02      |
| 155432 | 256  | 1    | 40   | 约为6e+02，不行 |
| 155432 | 128  | 1    | 40   | 约为7e+02，不行 |
| 155400 | 4    | 4    | 4    | 7.5613e+01 |
| 155400 | 16   | 4    | 4    | 2.4897e+02 |
| 155400 | 64   | 4    | 4    | 5.8120e+02 |
| 155400 | 128  | 4    | 4    | 6.4825e+02 |

**观察上面的测试结果，大致可发现如下规律**

1. N、P、Q相同的情况下，NB越大，效果越好
2. N相同的情况下，当NB比较小的时候，P * Q较小的效果更好；当NB比较大的时候，P * Q较大的效果更好
3. N、P * Q相同的情况下，当P取2，效果更好
4. NB、P、Q相同的情况下，N越大，效果越好



**最后选择 NB = 128及其之后的值，P = 2，Q = 20或者P = 2，Q = 10，N取值在155432之后的值**

| N      | NB   | P    | Q    | Gflops           |
| ------ | ---- | ---- | ---- | ---------------- |
| 155500 | 192  | 2    | 10   | 9.4601e+02       |
| 158426 | 128  | 2    | 20   | 不，数量级在e+01 |
| 157000 | 128  | 2    | 20   | 不，约为1e+02    |
| 156000 | 128  | 2    | 20   | 不，约为5e+02    |
| 155550 | 192  | 2    | 20   | 8.0448e+02       |
| 155500 | 128  | 2    | 20   | 8.8639e+02       |
| 155550 | 128  | 2    | 20   | 不，约为7e+02    |
| 155500 | 192  | 2    | 20   | 不，约为6e+02    |
| 155545 | 128  | 2    | 20   | 不，约为7e+02    |
| 155555 | 128  | 2    | 20   | 不，约为8e+02    |
| 155450 | 128  | 2    | 16   | 8.9853e+02       |
| 155550 | 128  | 2    | 16   | 8.7908e+02       |
| 155460 | 160  | 2    | 20   | 不，约为7e+02    |
| 155460 | 128  | 2    | 20   | 8.8936e+02       |
| 155500 | 128  | 2    | 10   | 9.1690e+02 |
| 155500 | 192  | 2    | 16   | 约为8e+02  |
| 155500 | 144  | 2    | 10   | 9.7864e+02 |
| 155500 | 168  | 2    | 10   | 9.3660e+02 |



### 测试结果

理论值为3.2e+03 Gflops

实际测试值最高为9.7864e+02 ，测试数据为N=155500, NB=144，P=2，Q=10

实际 / 理论 = 30.5825%



### 总结

**在学习HPL的过程中，学会了**

1. 基本的HPL调参操作（控制变量法
2. 手动编译安装软件
3. 查看系统硬件信息（比如cpu、内存等
4. 对PI平台进行操作（节点分配、tmux、ssh、基础的私钥和公钥知识

>**关于理论上的疑问**
>
>1. 上述N值取的是理论值，但是为什么理论值是N * N * 8 = memory，而不是N * 8 * N * 8 = memory？
>2. 明明有40个process可以跑，为什么是设置为2\*10而不是2\*20得到效果最好？
>3. 仅仅依靠调节参数似乎不能得到更好的结果的，那么接下来应该如何优化？



## 报告反馈（修正意见

**如何写文章？**

1. 搞清楚阅读的人是谁？——根据这个考虑内容

2. 写文章的时候应该先有比较outline，根据outline去确定需要填充什么内容（推动学习广度

3. 写总结的时候，需要使用描述性的语言而不是口语

   *比如使用“随着xxx，yyy”、”在xxx的前提下“等等*

4. 将最重要的内容放前面

5. 不要添加无所谓的数据，数据可以附在其他文件里面，而报告中的表格（其实处理成图更好）应该是为了解释结论的

6. 语言要凝练简洁



**如何提问？**

> 1. 操作+编译参数/选项+报错，便于别人复现（尽可能详细
> 2. 自己的猜想和探索
> 3. 提问的艺术（参考浏览器收藏集锦